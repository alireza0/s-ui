# 修复计划

## 1. 修复订阅链接域名不更新问题 (Issue #1013)

问题原因：订阅链接在保存配置时生成并存储在数据库中，导致访问时无法根据请求的域名动态更新。

### 修改 `sub/subService.go`
1.  **引入服务依赖**：在 `SubService` 结构体中嵌入 `service.InboundService`。
2.  **更新方法签名**：修改 `GetSubs` 方法，增加 `hostname` 参数。
3.  **重构链接生成逻辑**：
    *   获取 Client 信息。
    *   解析 `client.Inbounds` 获取关联的入站 ID 列表。
    *   调用 `s.InboundService.FromIds` 获取入站详情（需确保预加载 TLS 信息）。
    *   遍历入站信息，调用 `util.LinkGenerator` 并传入当前 `hostname` 动态生成链接。
    *   从 `client.Links` 中保留非 `local` 类型（即外部导入）的链接。
    *   合并动态生成的链接和外部链接，返回最终列表。

### 修改 `sub/subHandler.go`
1.  **提取 Hostname**：在 `subs` 方法中，从 `c.Request.Host` 提取当前请求的主机名（移除端口（如果是默认端口）或处理 IPv6 格式）。
2.  **传递参数**：调用 `s.SubService.GetSubs` 时传入提取的主机名。

### 修改 `service/inbounds.go`
1.  **优化数据查询**：更新 `FromIds` 方法，增加 `.Preload("Tls")`，确保查询入站时包含 TLS 配置，以便生成正确的 SSL/TLS 链接。

## 2. 修复删除关联已删除入站的用户时报错问题 (Issue #1008)

问题原因：用户数据中可能残留已删除的入站 ID，导致删除用户时系统尝试处理不存在的入站引用，引发异常（如 502 错误）。

### 修改 `service/client.go`
1.  **增加引用校验**：在 `Save` 方法的 `del`（删除用户）分支中：
    *   在解析出用户关联的 `inboundIds` 后，增加一步校验操作。
    *   执行数据库查询：`tx.Model(&model.Inbound{}).Where("id IN ?", inboundIds).Pluck("id", &validIds)`。
    *   仅将存在的 `validIds` 返回给上层 `ConfigService`。
    *   这确保了后续的 `RestartInbounds` 操作只针对有效的入站进行，优雅地忽略已丢失的引用，防止系统异常。

## 3. 验证计划
1.  **Issue #1013**：使用不同域名/IP 访问订阅地址，确认返回的节点链接地址随访问域名动态变化。
2.  **Issue #1008**：模拟 Issue 场景（创建入站 -> 创建用户并关联 -> 删除入站 -> 删除用户），确认删除用户操作成功且不再报 502 错误。
